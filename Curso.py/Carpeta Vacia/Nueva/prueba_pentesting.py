import os
import logging
import subprocess
from telegram import Update
from telegram.ext import Application, CommandHandler, ContextTypes

# ----------------- CONFIGURACI칍N -----------------

logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# OBTENER EL TOKEN DEL ENTORNO (M츼S SEGURO)
TOKEN = os.environ.get("TELEGRAM_TOKEN")

# **춰C츼MBIAME!** REEMPLAZA ESTE N칔MERO CON TU ID DE TELEGRAM REAL (usa @userinfobot)
AUTHORIZED_USER_ID = 12345678  

# ----------------- FUNCIONES DE UTILIDAD Y SEGURIDAD -----------------

def check_auth(update: Update) -> bool:
    """Verifica si el usuario que envi칩 el comando est치 autorizado."""
    user_id = update.message.from_user.id
    if user_id != AUTHORIZED_USER_ID:
        # Aqu칤 puedes cambiar el mensaje por uno discreto, ya que no est치s autorizado
        update.message.reply_text("Comando no reconocido o acceso denegado.") 
        logger.warning(f"Intento de acceso no autorizado desde el ID: {user_id}")
        return False
    return True

def clean_input(text: str) -> bool:
    """Verificaci칩n b치sica de seguridad (Sanitizaci칩n) para la entrada del usuario. 
       Permite solo caracteres seguros."""
    return all(c.isalnum() or c in '.-' for c in text)

# ----------------- MANEJADORES DE COMANDOS DE TELEGRAM -----------------

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not check_auth(update): return
    await update.message.reply_text(
        "Hola, soy tu Bot de Ciberseguridad Defensiva. "
        "Comandos disponibles:\n"
        "/whois [dominio] (Inteligencia de Amenazas)\n"
        "/scan_ports [ip] (Auditor칤a R치pida de TU Red)"
    )

async def whois_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ejecuta whois (OSINT)."""
    if not check_auth(update): return
    if not context.args or not clean_input(context.args[0]):
        await update.message.reply_text("Uso: /whois [dominio_valido]")
        return
    
    domain = context.args[0]
    await update.message.reply_text(f"游댌 Buscando WHOIS para {domain}...")
    
    # Uso seguro de subprocess.run para evitar Command Injection
    try:
        result = subprocess.run(['whois', domain], capture_output=True, text=True, timeout=15)
        response = f"--- WHOIS para {domain} ---\n\n{result.stdout[:4000]}" if result.stdout else f"No se encontr칩 informaci칩n WHOIS para {domain}."
        await update.message.reply_text(response)
    except Exception as e:
        await update.message.reply_text(f"Error al ejecutar WHOIS: {e}")

async def scan_ports_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Escanea puertos b치sicos con Nmap (춰SOLO PARA ACTIVOS PROPIOS!)."""
    if not check_auth(update): return
    if not context.args or not clean_input(context.args[0]):
        await update.message.reply_text("Uso: /scan_ports [IP_o_dominio_valido]")
        return

    target = context.args[0]
    await update.message.reply_text(f"游뚿 Escaneando puertos b치sicos para {target} con Nmap (-F)...")

    # Comando Nmap R치pido. Se usa -F (Fast Scan).
    try:
        result = subprocess.run(['nmap', '-F', target], capture_output=True, text=True, timeout=300) 
        response = f"--- NMAP Reporte R치pido para {target} ---\n\n{result.stdout}" if result.stdout else f"Nmap no arroj칩 resultados para {target}."
        await update.message.reply_text(response)
    except Exception as e:
        await update.message.reply_text(f"Error al ejecutar Nmap: {e}. 쮼st치 instalado 'nmap'?")

# ----------------- INICIO DEL BOT -----------------

def main() -> None:
    """Funci칩n principal para iniciar el bot."""
    if not TOKEN:
        logger.error("Error: La variable de entorno TELEGRAM_TOKEN no est치 configurada.")
        return

    application = Application.builder().token(TOKEN).build()

    # Registra los handlers
    application.add_handler(CommandHandler("start", start_command))
    application.add_handler(CommandHandler("whois", whois_command))
    application.add_handler(CommandHandler("scan_ports", scan_ports_command))

    print("Bot de Seguridad iniciado y escuchando...")
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    main()